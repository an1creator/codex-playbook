# Project Work Rules (root)

## 0) Task Structure (source of work mode)
Task folders:
- `tasks/bugs/`
- `tasks/features/`
- `tasks/refactoring/`
- `tasks/tests/`
- `tasks/plans/`

Archive:
- `tasks/*/completed/` — only for completed tasks (do not create new ones here).

Each task folder has a policy file:
- `tasks/bugs/AGENTS.md`
- `tasks/features/AGENTS.md`
- `tasks/refactoring/AGENTS.md`
- `tasks/tests/AGENTS.md`
- `tasks/plans/AGENTS.md`

IMPORTANT: even if policy was not automatically "mixed in", you MUST OPEN and follow the policy for the task category.

## 1) Required Project Documents
- `docs/codex/PROJECT_CONTRACT.md` — project contract (LOCKED after bootstrap).
- `docs/codex/AGENT_GUIDE.md` — architectural guide (no code).
- `docs/codex/CONTEXT_INDEX.md` — context index (created after first code task).
- `CONTEXT.md` — local folder context (invariants/boundaries/risks).
- `X-work.md` — task work file next to `X.md` (until completion).

#### 1.1) Templates
- Project templates are in `docs/codex/templates/`.
- Local context template: `docs/codex/templates/CONTEXT.md`.
Rule:
- If you need to create a new `<some-folder>/CONTEXT.md`, copy content from `docs/codex/templates/CONTEXT.md` and fill only relevant sections.
- Delete empty sections (do not leave headers without content).
- Do not create `CONTEXT.md` "everywhere": only by triggers (new/affected zone by `git diff --name-only`) or by explicit user request.


## 2) Two-Phase Protocol (STRICT)
When receiving task `X.md` from `bugs|features|refactoring|test|plans`:
1) Create `X-work.md` next to `X.md`.
2) Fill `X-work.md` according to category template (from policy).
3) Ask user to approve plan.

Modes:
- "Correction" mode: change ONLY `X-work.md` (and planning documents if necessary).
- "Execution" mode: change code strictly according to approved plan.

Gates:
- FORBIDDEN to change code/configs before explicit user approval (`Status: APPROVED`).
- Any deviation from plan = update `X-work.md` + get approval again.

## 3) Context Gathering Before Plan (STRICT)
Before writing Plan:
1) Compose `Working set` (which folders/files will likely be touched).
2) Read:
   - `docs/codex/PROJECT_CONTRACT.md`
   - relevant sections of `docs/codex/AGENT_GUIDE.md`
   - `CONTEXT.md` in `Working set` folders (if exist)
   - `docs/codex/CONTEXT_INDEX.md` (if already exists) and follow relevant links
3) Record this in `Context loaded` inside `X-work.md` (only actually opened files).

## 4) Project Contract (LOCKED)
- `docs/codex/PROJECT_CONTRACT.md` — single source of truth for run/checks.
- If LOCKED: do not change it automatically.
- Contract can only be changed:
  - by separate task from `plans/`
  - or by explicit user request in current task

## 5) Git (universal)
Branch:
- `<category>/<task-slug>`
  - category: `bugs|features|refactoring|test|plans`
  - task-slug: filename `X.md` without extension

Commits (if repo has no other practice):
- Format: `scope: subject` (scope is required)
- Subject: imperative mood, max 72 chars
- Examples: `api: add token refresh`, `ui: handle empty state`

## 6) Task Completion and Move to completed (STRICT)
When work is finished:
1) In `X-work.md` set `Status: DONE` and record completed checks.
2) Move both files:
   - `X.md` -> `<category>/completed/X.md`
   - `X-work.md` -> `<category>/completed/X-work.md`

## 7) Context Creation After First Code Task (STRICT)
If task was not `plans/` and changed code/configs, and `docs/codex/CONTEXT_INDEX.md` doesn't exist yet:
- At end of task create `docs/codex/CONTEXT_INDEX.md`.
- By `git diff --name-only` select "key folders" that were actually affected.
- For each such folder create/update `CONTEXT.md` (minimally).
- Add entries to `docs/codex/CONTEXT_INDEX.md` for these `CONTEXT.md`.

## 7.1) Context Capture Settings (source of truth)
- All context capture settings are defined in docs/codex/CONTEXT_INDEX.md.
- When creating X-work.md, read the settings from CONTEXT_INDEX.md and fill the Context updates section accordingly.

## 8) Agent Communication and Language Policy
#### 8.1) Chat / Interactive Communication
- Language: **English**
- Scope: all explanations, answers, clarifying questions, and discussions with the user.
- The agent must not switch languages unless explicitly instructed by the user.
#### 8.2) Source Code Comments
- Language: **English**
- Scope: inline comments, docstrings, JSDoc / PHPDoc / Python docstrings, README fragments generated by the agent.
- Comments must be concise and technical. Do not translate identifiers or keywords.

#### 8.3) Commit Messages
- Language: **English**
- Format: imperative mood (e.g. `Add validation for user input`)
- No emojis, no localization, no multi-language commits.

#### 8.4) Identifiers and Code
- Language: **English only**
- Applies to: variable names, function names, class names, file names, configuration keys.
- Never transliterate or translate identifiers.

#### 8.5) Exceptions
- Language rules may be overridden only by an explicit user instruction.
- If instructions conflict, **AGENTS.md takes priority**.
